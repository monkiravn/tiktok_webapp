{% extends "base.html" %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Header Section -->
    <div class="p-4 pb-3">
        <h1 class="display-6 fw-bold text-gradient mb-2">
            <i class="fas fa-broadcast-tower text-primary me-2"></i>
            Live Monitor
        </h1>
        <p class="text-muted mb-0">Monitor and record TikTok live streams automatically</p>
    </div>

    <!-- Control Panel -->
    <div class="px-4 pb-3">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2 text-primary"></i>
                    Control Panel
                </h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="settingsBtn">
                        <i class="fas fa-cog me-1"></i>
                        Settings
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" id="updateCliBtn">
                        <i class="fas fa-download me-1"></i>
                        Update CLI
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fab fa-tiktok"></i>
                            </span>
                            <input type="text" class="form-control" id="usernameInput" 
                                   placeholder="Enter TikTok username or URL">
                            <button class="btn btn-success" type="button" id="addUserBtn">
                                <i class="fas fa-plus me-1"></i>
                                Add Monitor
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Total Monitors: <span id="monitorCount">{{ monitors|length }}</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monitors Table -->
    <div class="px-4 pb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2 text-primary"></i>
                    Monitored Users
                </h5>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshBtn">
                    <i class="fas fa-refresh me-1"></i>
                    Refresh
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="monitorsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Start Time</th>
                                <th>Last Check</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monitorsTableBody">
                            {% if monitors %}
                                {% for monitor in monitors %}
                                <tr data-username="{{ monitor.username }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fab fa-tiktok me-2 text-dark"></i>
                                            <span class="fw-semibold">{{ monitor.username }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if monitor.status == 'recording' else 'info' if monitor.status == 'monitoring' else 'secondary' }}">
                                            {% if monitor.status == 'recording' %}
                                                <i class="fas fa-record-vinyl me-1"></i>
                                                Recording
                                            {% elif monitor.status == 'monitoring' %}
                                                <i class="fas fa-eye me-1"></i>
                                                Monitoring
                                            {% else %}
                                                <i class="fas fa-stop me-1"></i>
                                                Stopped
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if monitor.start_time %}
                                            <small>{{ monitor.start_time[:19]|replace('T', ' ') }}</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if monitor.last_check %}
                                            <small>{{ monitor.last_check[:19]|replace('T', ' ') }}</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm remove-monitor" 
                                                data-username="{{ monitor.username }}">
                                            <i class="fas fa-trash me-1"></i>
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr id="noMonitorsRow">
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        <i class="fas fa-inbox fa-2x mb-3 opacity-50"></i>
                                        <h6>No monitors active</h6>
                                        <p class="small mb-0">Add a TikTok username to start monitoring</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settingsModalLabel">
                    <i class="fas fa-cog me-2"></i>
                    Live Recording Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="checkInterval" class="form-label">Check Interval (minutes)</label>
                                <input type="number" class="form-control" id="checkInterval" 
                                       value="{{ settings.check_interval }}" min="1" max="60">
                                <small class="form-text text-muted">How often to check if user is live</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="duration" class="form-label">Recording Duration (seconds)</label>
                                <input type="number" class="form-control" id="duration" 
                                       value="{{ settings.duration or '' }}" min="60">
                                <small class="form-text text-muted">Leave empty for unlimited recording</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="outputDir" class="form-label">Output Directory</label>
                        <input type="text" class="form-control" id="outputDir" 
                               value="{{ settings.output_dir }}">
                        <small class="form-text text-muted">Where to save recorded videos</small>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="useTelegram" 
                               {{ 'checked' if settings.use_telegram else '' }}>
                        <label class="form-check-label" for="useTelegram">
                            Enable Telegram Notifications
                        </label>
                        <small class="form-text text-muted d-block">Send recordings to Telegram</small>
                    </div>
                    
                    <div id="telegramConfig" class="border rounded p-3 bg-light" 
                         style="{{ 'display: none;' if not settings.use_telegram else '' }}">
                        <h6>Telegram Configuration</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="telegramApiId" class="form-label">API ID</label>
                                    <input type="text" class="form-control" id="telegramApiId" 
                                           value="{{ settings.telegram_config.get('api_id', '') }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="telegramApiHash" class="form-label">API Hash</label>
                                    <input type="text" class="form-control" id="telegramApiHash" 
                                           value="{{ settings.telegram_config.get('api_hash', '') }}">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="telegramChannel" class="form-label">Channel/Chat ID</label>
                            <input type="text" class="form-control" id="telegramChannel" 
                                   value="{{ settings.telegram_config.get('channel', '') }}">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">
                    <i class="fas fa-save me-1"></i>
                    Save Settings
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/live_monitor.js') }}"></script>
{% endblock %}